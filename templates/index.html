{% extends "base.html" %}

{% block title %}校园实物招领平台 - 首页{% endblock %}

{% block content %}
    <!-- 页面头部标语 -->
    <div style="text-align: center; margin: 3rem 0 2rem; padding: 0 1rem;">
        <h1 style="color: var(--primary); font-size: 2rem; margin-bottom: 1rem; font-weight: 700; line-height: 1.4;">校园失物招领平台</h1>
        <p style="color: var(--gray-600); max-width: 600px; margin: 0 auto; line-height: 1.8; font-size: 1rem;">
            分享失物信息，助力物归原主——让每一件遗失的物品都能找到回家的路
        </p>
    </div>

    <!-- 招领物品列表 -->
    {% if items %}
        <div class="items-list">
            {% for item in items %}
                <div class="item-card" style="transition: all 0.3s ease; transform: translateY(0);">
                    <!-- 物品图片 -->
                    {% if item.image %}
                        <!-- 适配后端图片存储路径（uploads文件夹下） -->
                        <div style="overflow: hidden; height: 180px; position: relative;">
                            <img src="{{ url_for('static', filename='uploads/' + item.image) }}" 
                                 alt="{{ item.title }}" 
                                 class="item-img"
                                 style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; cursor: pointer;">
                            <!-- 图片加载失败兜底（仅作占位，事件用JS绑定） -->
                            <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" 
                                 alt="" 
                                 class="img-placeholder"
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none;">
                        </div>
                    {% else %}
                        <div style="width: 100%; height: 180px; background-color: var(--gray-100); display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease;">
                            <span style="color: var(--gray-400); text-align: center;"><i class="fa-solid fa-image fa-2x"></i><br>暂无图片</span>
                        </div>
                    {% endif %}

                    <!-- 卡片内容 -->
                    <div class="card-body">
                        <h3 style="color: var(--gray-900); font-size: 1.15rem; margin-bottom: 1rem; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ item.title }}
                        </h3>
                        <div class="info-row" style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <i class="fa-solid fa-location-dot fa-fw text-primary"></i> 
                            <span style="color: var(--gray-600); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ item.place }}</span>
                        </div>
                        <div class="info-row" style="margin-bottom: 0.5rem; font-size: 0.9rem;">
                            <i class="fa-solid fa-calendar fa-fw text-primary"></i> 
                            <span style="color: var(--gray-600);">{{ item.time.strftime('%Y-%m-%d') }}</span>
                        </div>
                        <div class="info-row" style="margin-bottom: 1rem; font-size: 0.9rem;">
                            <i class="fa-solid fa-user fa-fw text-primary"></i> 
                            <span style="color: var(--gray-600);">发布人：{{ item.user.username }}</span>
                        </div>
                        <p class="description" style="color: var(--gray-600); margin-bottom: 1.2rem; font-size: 0.95rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1;">
                            {{ item.description or '无物品描述' }}
                        </p>
                        <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn" style="width: 100%;">
                            <i class="fa-solid fa-eye"></i> 查看详情
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- 列表为空提示 -->
    {% else %}
        <div class="card" style="text-align: center; padding: 4rem 2rem; max-width: 600px; margin: 3rem auto; box-shadow: var(--shadow-md);">
            <div style="font-size: 4rem; margin-bottom: 1.5rem; color: var(--primary-light); opacity: 0.8; transition: transform 0.3s ease;">
                <i class="fa-solid fa-box-open"></i>
            </div>
            <h3 style="color: var(--gray-700); margin-bottom: 1rem; font-size: 1.3rem; font-weight: 600;">暂无招领信息</h3>
            <p style="color: var(--gray-500); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto; line-height: 1.8; font-size: 1rem;">
                还没有人发布招领信息，快来成为第一个分享者吧～
            </p>
            {% if session.user_id %}
                <a href="{{ url_for('publish') }}" class="btn" style="padding: 0.9rem 2.5rem; font-size: 1.05rem;">
                    <i class="fa-solid fa-plus"></i> 发布招领信息
                </a>
            {% else %}
                <a href="{{ url_for('login') }}" class="btn" style="padding: 0.9rem 2.5rem; font-size: 1.05rem;">
                    <i class="fa-solid fa-right-to-bracket"></i> 登录后发布
                </a>
            {% endif %}
        </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 物品卡片hover效果
            const itemCards = document.querySelectorAll('.item-card');
            itemCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-5px)';
                    card.style.boxShadow = 'var(--shadow-md)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'var(--shadow)';
                });
            });

            // 2. 图片点击放大效果
            const itemImages = document.querySelectorAll('.item-img');
            itemImages.forEach(img => {
                img.addEventListener('click', function() {
                    const mask = document.createElement('div');
                    mask.style.position = 'fixed';
                    mask.style.top = '0';
                    mask.style.left = '0';
                    mask.style.width = '100%';
                    mask.style.height = '100%';
                    mask.style.backgroundColor = 'rgba(0,0,0,0.8)';
                    mask.style.zIndex = '9999';
                    mask.style.display = 'flex';
                    mask.style.alignItems = 'center';
                    mask.style.justifyContent = 'center';
                    mask.style.cursor = 'zoom-out';

                    const bigImg = document.createElement('img');
                    bigImg.src = this.src;
                    bigImg.style.maxWidth = '90%';
                    bigImg.style.maxHeight = '90%';
                    bigImg.style.borderRadius = 'var(--radius)';
                    bigImg.style.transition = 'transform 0.3s ease';

                    mask.appendChild(bigImg);
                    document.body.appendChild(mask);
                    document.body.style.overflow = 'hidden';

                    mask.addEventListener('click', function() {
                        document.body.removeChild(mask);
                        document.body.style.overflow = 'auto';
                    });
                });

                // 3. 图片加载失败处理（核心修复：用JS绑定onerror，避免内联字符串冲突）
                img.addEventListener('error', function() {
                    const placeholder = this.nextElementSibling; // 获取占位图
                    this.style.display = 'none'; // 隐藏原图片
                    placeholder.style.display = 'none'; // 隐藏占位图
                    
                    const parent = this.parentElement; // 图片容器
                    parent.style.backgroundColor = 'var(--gray-100)';
                    parent.style.display = 'flex';
                    parent.style.alignItems = 'center';
                    parent.style.justifyContent = 'center';
                    
                    // 插入错误提示（无字符串嵌套，绝对不会报错）
                    parent.innerHTML = '<span style="color: var(--gray-400); text-align: center;"><<i class="fa-solid fa-image fa-2x"></</i><br>图片加载失败</span>';
                });
            });

            // 4. 空状态图标hover效果
            const emptyIcon = document.querySelector('.fa-box-open');
            if (emptyIcon) {
                emptyIcon.parentElement.addEventListener('mouseenter', () => {
                    emptyIcon.style.transform = 'scale(1.1)';
                });
                emptyIcon.parentElement.addEventListener('mouseleave', () => {
                    emptyIcon.style.transform = 'scale(1)';
                });
            }
        });
    </script>
{% endblock %}